{% extends "template/master.html" %}

{% block headerAfter%}
{% endblock %}
{% block content %}
    <div class="title-block">
        <h3 class="title"> {{ appName }} Dashboard </h3>
    </div>
    <section class="section">
    </section>
{% endblock %}
{% block script %}
    <script src="/js/chartjs/chartjs.bundle.min.js"></script>
    <script src="/js/chartjs/chartjs-plugin-labels.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        //let socket = io();
        let colors = {
            red: "rgb(255, 99, 132)",
            blue: "rgb(54, 162, 235)"
        };

        let salesOrderLineConfig = {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '# of transaction',
                    backgroundColor: colors.red,
                    borderColor: colors.red,
                    data: [],
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: ''
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Number'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        };
        
        let salesOrderChartCtx = document.getElementById('salesOrderChart').getContext('2d');
        window.salesOrderChart = new Chart(salesOrderChartCtx, salesOrderLineConfig);

        let formatValue = function(value) {
            let parts = (value || 0).toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            return "Rp. " + parts.join(".");
        };
        let dashboardSocket = io('/dashboard', { forceNew: true });
        dashboardSocket.on('data', function(data) {
            let salesOrderData = data.data.salesOrder;
            let summaryData = data.data.summary;
            let metaData = data.data.meta;

            let labels = metaData.dates;

            let salesOrderChartData = [];
            salesOrderData.forEach(function(salesOrder){
                salesOrderChartData.push(salesOrder.num);
            });

            salesOrderLineConfig.data.datasets[0].data = salesOrderChartData;
            salesOrderLineConfig.data.labels = labels;
            window.salesOrderChart.update();

            $('[data-role="summary-value"]').html(formatValue(summaryData.today_value));
            $('[data-role="summary-value-week"]').html(formatValue(summaryData.last_week_value));
        });
    </script>
{% endblock %}